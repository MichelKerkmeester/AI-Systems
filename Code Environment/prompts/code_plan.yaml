# ─────────────────────────────────────────────────────────────────
# FRAMEWORK
# ─────────────────────────────────────────────────────────────────
role: Strategic planning coordinator and architect
purpose: Analyze project comprehensively and create consolidated planning document
action: Analyze from multiple planning perspectives → Create single consolidated plan → Write to target document

operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_task_checklists
  validation: final_verification

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  use_worktree: |
    [USE_WORKTREE]
    
    Enable isolated worktree for planning work (optional).
    - true: Create isolated workspace for complex planning
    - false: Work in current directory (default, fine for most planning)
  
  target_document: |
    [TARGET_DOCUMENT]
    
    Where to write the consolidated plan. Examples:
    - /specs/001/plan.md
    - /plans/2025-01/feature-x.md
    - /docs/project-plan.md
    Leave empty to default to /specs
  
  context: |
    [CONTEXT]
    
    Provide background information for planning. Examples:
    - Project goals and objectives
    - Constraints and limitations
    - Available resources
    - Timeline expectations
    - Dependencies on other work
    - Technical requirements
    - Success criteria
    Leave empty to infer from REQUEST.
  
  complexity: |
    [COMPLEXITY]
    
    Planning depth and detail level:
    - quick: Light planning (Scope, Breakdown, Timeline)
    - standard: Comprehensive planning (default)
    - deep: Exhaustive planning with extended analysis plus 30% timeline buffer
  
  request: |
    [REQUEST]
    
    Describe what needs to be planned. Be specific about:
    - The project or feature to plan
    - Objectives and goals
    - Scope boundaries
    - Key deliverables
    - Any specific planning concerns
    This field is REQUIRED.

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  use_worktree:
    type: boolean
    default: false  # Optional isolation for planning work
    note: "Enable for complex planning requiring isolation. Most planning work fine on main branch."

  defaults:
    use_worktree_empty: false
    target_document_empty: "/specs"
    context_empty: "Infer from [REQUEST]"
    complexity_empty: "standard"
    request_empty: "Error: REQUEST required"
  
  complexity_policy:
    quick:
      planning_aspects: [Scope, Breakdown, Timeline]
      phases: 1_to_3
      review_depth: light
    standard:
      planning_aspects: [Scope, Breakdown, Resource, Timeline, Quality]
      phases: 3_to_7
      review_depth: comprehensive
    deep:
      planning_aspects: [Scope, Breakdown, Resource, Timeline, Quality, Compliance]
      phases: 7_plus
      review_depth: exhaustive
      timeline_adjustment: plus_30_percent
  
  path_policy:
    validation: must_exist_or_create
    safety: restrict_to_target_document
    auto_folder: "./plans/[YYYY-MM]/[project-slug]/"

# ─────────────────────────────────────────────────────────────────
# PLANNING AREAS
# ─────────────────────────────────────────────────────────────────
planning_areas:
  scope:
    focus: Define project boundaries and success criteria
    aspects: objectives_boundaries_success_criteria_constraints
  
  breakdown:
    focus: Decompose project into phases and tasks
    aspects: phases_tasks_dependencies_milestones
  
  resource:
    focus: Identify requirements and dependencies
    aspects: tools_skills_external_deps_blockers
  
  timeline:
    focus: Estimate durations and sequencing
    aspects: durations_sequencing_critical_path_buffer
  
  quality:
    focus: Validate completeness and identify risks
    aspects: completeness_feasibility_risks_gaps

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_initialization:
    input_source: USER_INPUTS_SECTION_ABOVE
    target_document: "[TARGET_DOCUMENT] → apply defaults"
    context: "[CONTEXT] → use for agent context"
    complexity: "[COMPLEXITY] → apply policy"
    request: "[REQUEST] → main planning request"
    action: Validate inputs and prepare agent deployment
    validation:
      - request_not_empty
      - target_document_accessible_or_creatable
      - complexity_valid
    outputs:
      - normalized_inputs
      - planning_configuration
      - plan_filename: "[TARGET_DOCUMENT]/plan-[slug]-[YYYYMMDD-HHMMSS].md"

  step_2_workspace_setup:
    condition: use_worktree == true
    action: Create isolated worktree via git-worktrees skill
    strategy: main_temp  # Always main_temp for code workflows
    description: |
      Create isolated workspace for planning work (optional).
      Allows developing complex plans in isolation.
      Work happens in .worktrees/plan-{timestamp} on temp/plan-{timestamp} branch.
    inputs:
      task_description: derived_from_request
      branch_strategy: main_temp
    outputs:
      worktree_path: absolute_path
      git_branch: temp/plan-{timestamp}
    note: |
      If use_worktree=true: Create worktree for isolated planning work
      If use_worktree=false: Skip, work in current directory

  step_3_comprehensive_planning:
    description: Plan from all critical perspectives
    purpose: Create complete project plan covering all aspects
    
    planning_approach:
      - Scope analysis: Define objectives, boundaries, success criteria, constraints
      - Task breakdown: Decompose into phases, tasks, dependencies, milestones
      - Resource planning: Identify tools, skills, external dependencies, blockers
      - Timeline estimation: Create duration estimates, sequencing, critical path, buffers
      - Quality validation: Assess completeness, feasibility, risks, gaps
    
    context:
      - "[CONTEXT]"
      - "[REQUEST]"
      - "[TARGET_DOCUMENT]"
    
    outputs:
      scope_plan:
        type: markdown
        sections: [objectives, boundaries, success_criteria, constraints]
      
      breakdown_plan:
        type: markdown
        sections: [phases, tasks_per_phase, dependencies, milestones]
      
      resource_plan:
        type: markdown
        sections: [required_tools, required_skills, external_dependencies, blockers]
      
      timeline_plan:
        type: markdown
        sections: [duration_estimates, task_sequencing, critical_path, buffer_allocation]
        complexity_scaling:
          quick: minimal_estimates
          standard: balanced_estimates
          deep: detailed_ranges
      
      quality_assessment:
        type: markdown
        sections: [completeness_check, feasibility_assessment, risk_matrix, identified_gaps]

  step_4_synthesis_and_integration:
    input: comprehensive_planning_from_step_2
    action: Synthesize all planning perspectives into cohesive plan
    purpose: Create integrated project roadmap

    synthesis_focus:
      - identify_overlaps_and_complementary_elements
      - resolve_conflicts_between_planning_aspects
      - validate_internal_consistency
      - assess_overall_completeness
      - flag_risks_gaps_or_concerns
      - identify_integration_points
      - note_contradictions_or_tensions
      - evaluate_feasibility_holistically

    output: integrated_planning_guidance

  step_5_finalization:
    input: integrated_plan_from_step_4
    action: Create single consolidated markdown plan document
    
    process:
      - aggregate_all_planning_outputs
      - apply_synthesis_insights
      - integrate_complementary_elements
      - resolve_conflicts_per_guidance
      - apply_priority_tags: P0_critical_to_P3_nice_to_have
      - structure_into_unified_markdown
      - validate_against_checklist
      - write_single_file
      - display_summary
    
    validation_checklist:
      - all_planning_aspects_complete
      - synthesis_step_completed
      - min_3_phases_unless_trivial
      - all_tasks_have_owner_effort_success_criteria
      - dependencies_acyclic
      - timeline_has_buffer
      - risks_identified_with_severity
      - success_metrics_measurable
      - filename_convention_followed
      - markdown_syntax_valid
      - single_file_output_confirmed
    
    output_markdown_sections:
      - executive_summary: from_scope_planning
      - scope_and_boundaries: from_scope_planning
      - phase_breakdown: from_breakdown_planning
      - resource_requirements: from_resource_planning
      - timeline_overview: from_timeline_planning
      - risk_matrix: from_quality_assessment
      - next_actions: synthesized_from_all
      - plan_metadata: synthesis_info
    
    completion:
      write: "[TARGET_DOCUMENT]/plan-[slug]-[timestamp].md"
      display:
        - file_path
        - summary: phases_tasks_timeline
        - alerts: high_severity_risks
        - synthesis_notes: integration_highlights
        - next_steps: immediate_actions

  step_6_save_context:
    action: Save planning conversation context
    invocation: Skill(skill: "save-context")
    description: |
      Preserve comprehensive planning conversation including:
      - All planning outputs from step 2
      - Synthesis and integration decisions
      - Conflict resolutions and trade-offs
      - Final plan structure and rationale
    outputs:
      - context_file: "planning-session-[DD-MM-YY_HH-MM].md"
      - workflow_flowchart: auto_generated
      - planning_decisions: documented
    note: |
      Context saved alongside plan for complete record.
      Captures all planning outputs and synthesis process.

  step_7_integration_and_cleanup:
    condition: use_worktree == true
    action: Integrate plan and cleanup worktree
    strategy: main_temp  # Always main_temp for code workflows
    description: |
      After successful plan creation, integrate changes back to main.
      Fast-forward merge ensures clean integration.
      Cleanup removes temporary plan branch and worktree.
    steps:
      - verify_worktree_clean
      - return_to_main_repo
      - checkout_main_and_update
      - merge_temp_branch_fast_forward_only
      - delete_temp_branch
      - remove_worktree
    note: |
      If use_worktree=true: Integrate plan to main and cleanup
      If use_worktree=false: Skip (already working on main)

# ─────────────────────────────────────────────────────────────────
# OUTPUT FORMAT
# ─────────────────────────────────────────────────────────────────
output_format:
  primary_deliverable:
    location: "[TARGET_DOCUMENT]/plan-[slug]-[timestamp].md"
    sections:
      - executive_summary
      - scope_and_boundaries
      - phase_breakdown_with_tasks
      - resource_requirements
      - timeline_with_milestones
      - risk_matrix_and_mitigations
      - success_metrics
      - immediate_next_actions
    formatting:
      - markdown_with_headers
      - tasks_as_checklists
      - risks_as_tables
      - timeline_as_gantt_approximation

  metadata:
    - synthesis_timestamp
    - agent_outputs_referenced
    - complexity_level
    - confidence_assessment


# ─────────────────────────────────────────────────────────────────
# QUALITY & VALIDATION
# ─────────────────────────────────────────────────────────────────
quality_standards:
  completeness_criteria:
    - all_5_agents_completed_successfully
    - review_identified_and_resolved_conflicts
    - synthesis_covers_all_critical_aspects
    - no_circular_dependencies
    - timeline_is_realistic_with_buffer

  validation_checklist:
    - phases: min_3_unless_trivial
    - tasks: all_have_owner_and_effort
    - dependencies: clearly_defined_and_acyclic
    - risks: assessed_with_severity_and_mitigation
    - success_metrics: measurable_and_achievable
    - timeline: includes_30_percent_buffer
    - resources: identified_and_available

  output_requirements:
    - single_consolidated_markdown_file
    - follows_template_structure
    - includes_metadata_section
    - all_sections_populated
    - markdown_syntax_valid

# ─────────────────────────────────────────────────────────────────
# ERROR HANDLING
# ─────────────────────────────────────────────────────────────────
error_handling:
  agent_failure:
    action: retry_with_simplified_scope
    fallback: note_limitation_in_quality_section
    max_retries: 2
    impact_on_review: proceed_with_available_outputs
  
  review_identifies_critical_gap:
    action: return_to_specific_agent_for_replanning
    max_iterations: 2
    fallback: document_gap_in_plan_warnings
  
  validation_failure:
    action: return_to_synthesis_with_corrections
    max_iterations: 2
    fallback: generate_with_warnings_section
  
  file_write_failure:
    action: check_permissions
    fallback: offer_stdout_output

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
    - deploy_all_5_agents_in_parallel
    - allow_agents_full_native_plan_mode_autonomy
    - review_all_agent_outputs_comprehensively
    - create_single_consolidated_markdown_file
    - validate_folder_path_before_write
    - include_measurable_success_criteria
    - identify_dependencies_explicitly
    - allocate_timeline_buffer
    - generate_plan_filename_with_timestamp
    - enforce_review_before_synthesis
  NEVER:
    - skip_agent_execution
    - skip_review_step
    - create_multiple_output_files
    - constrain_agent_native_planning
    - create_circular_dependencies
    - omit_risk_assessment