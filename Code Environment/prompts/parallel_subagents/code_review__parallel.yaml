# ───────────────────────────────────────────────────────────────────
# FRAMEWORK
# ───────────────────────────────────────────────────────────────────
role: Senior Code Reviewer conducting comprehensive code review with parallel specialists
purpose: Technical code quality analysis using parallel experts for comprehensive review
action: Run parallel code review (standards, quality, security, performance, architecture, accessibility) → review → synthesize research.md

operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_task_checklists
  validation: final_verification

review_philosophy:
  principle: "Quality first, prescriptive guidance second"
  approach: "Comprehensive analysis with actionable recommendations"
  mandate: "Identify issues, assess impact, propose solutions"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS
# ───────────────────────────────────────────────────────────────────
user_inputs:
  git_branch: |
    [GIT_BRANCH]
    
    Git branch name for the work. Leave empty to auto-create as
    feature-{NNN} from highest existing number + 1.
  
  spec_folder: |
    [SPEC_FOLDER]
    
    Spec folder path (e.g., specs/001 or specs/001-feature-name).
    Leave empty to auto-create next available spec number.
  
  scope: |
    [FILES]
    
    Files or folders to review. Can be:
    - Single file path
    - Multiple paths (one per line)
    - Glob patterns (e.g., src/**/*.js)
    - Git diff range (e.g., main...feature-branch)
    - Leave empty to review all recent changes or infer from REQUEST
  
  review_type: |
    [REVIEW_TYPE]
    
    Type of review to perform. Options:
    - comprehensive (all aspects)
    - security (security vulnerabilities)
    - performance (performance issues)
    - maintainability (code quality, readability)
    - architecture (structural design)
    - accessibility (a11y compliance)
    - standards (coding standards compliance)
    Leave empty for comprehensive review.
  
  context: |
    [CONTEXT]
    
    Provide background information. Examples:
    - Purpose of the code
    - Recent changes or refactoring
    - Known issues or concerns
    - Team coding standards
    - Technology stack details
    - Deployment environment
    Leave empty to infer from codebase analysis.
  
  issues: |
    [ISSUES]
    
    List known issues or concerns to investigate. Examples:
    - Bug reports
    - Performance complaints
    - Security concerns
    - Technical debt areas
    - Code smell locations
    - Failing tests
    Leave empty to discover during review.
  
  request: |
    [REQUEST]
    
    Describe the review goals. Be specific about:
    - What to focus on
    - Specific concerns to address
    - Quality standards to verify
    - Areas needing improvement
    - Success criteria
    Leave empty for general code review.
  
  environment: |
    [STAGING LINK]
    
    Staging or production URL for runtime testing. Leave empty to skip
    browser-based testing and focus on static analysis.

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "spec_folder path using pattern specs/{NNN} or specs/{NNN-name}"
    fallback: "Extract numeric portion or use timestamp if extraction fails"

  defaults:
    git_branch_empty: "Auto-create feature-{NNN} from highest +001"
    spec_folder_empty: "Auto-create specs/{NNN} from highest +001"
    scope_empty: "Infer from recent git changes or [REQUEST]"
    review_type_empty: "comprehensive"
    context_empty: "Infer from codebase analysis"
    issues_empty: "Discover during review"
    request_empty: "General code quality review"
    environment_empty: "Skip runtime testing"

  scope_policy:
    default: "src/**"
    rule: "Limit file operations to scope when provided"

# ─────────────────────────────────────────────────────────────────
# SUB-AGENTS (PARALLEL REVIEW SPECIALISTS)
# ─────────────────────────────────────────────────────────────────
sub_agents:
  - id: code_quality_standards
    name: Code Quality & Standards Specialist
    role: Review standards compliance, code quality, maintainability, and technical debt
    focus: code_standards_initialization_patterns_animation_strategy_readability_complexity_duplication_modularity_refactoring_opportunities_technical_debt_documentation_debt
  - id: security_performance
    name: Security & Performance Specialist
    role: Identify security vulnerabilities and performance bottlenecks across all attack vectors
    focus: input_validation_auth_authz_data_protection_dependencies_owasp_top_10_runtime_perf_resource_usage_browser_perf_network_perf_60fps_animations
  - id: architecture_accessibility
    name: Architecture & Accessibility Specialist
    role: Evaluate architectural design patterns and verify WCAG compliance
    focus: design_patterns_structure_scalability_integration_api_design_semantic_html_aria_keyboard_nav_screen_reader_color_contrast
  - id: synthesis_review
    name: Lead Reviewer & Synthesizer
    role: Validate completeness, resolve conflicts, prioritize findings, and produce comprehensive research.md
    focus: validation_conflict_resolution_completeness_severity_assessment_prioritization_markdown_generation_section_organization_findings_integration_recommendations_session_documentation_decision_capture

# ─────────────────────────────────────────────────────────────────
# WORKFLOW (PARALLEL OUTPUT QA BY MAIN AGENT)
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    input_source: USER_INPUTS_SECTION_ABOVE
    git_branch: "[GIT_BRANCH] → auto-create if empty"
    spec_folder: "[SPEC_FOLDER] → auto-create if empty"
    scope: "[FILES] → infer from git changes if empty"
    review_type: "[REVIEW_TYPE] → comprehensive if empty"
    context: "[CONTEXT] → infer from codebase if empty"
    issues: "[ISSUES] → discover if empty"
    request: "[REQUEST] → REQUIRED"
    environment: "[STAGING LINK] → skip runtime tests if empty"
    action: |
      1. Analyze user inputs and confirm understanding
      2. Prepare for code review research
    outputs:
      - review_scope_defined
      - review_objectives_identified
      - analysis_strategy_determined
    validation: scope_defined

  step_2_pre_work_review:
    required_documents:
      - AGENTS.md
      - .claude/knowledge/code_standards.md
      - .claude/knowledge/debugging.md
      - .claude/knowledge/initialization_pattern.md
      - .claude/knowledge/animation_strategy.md
    verification: MUST_REVIEW
    validation: principles_established
    spike_documentation:
      command: /speckit.spike [research-question]
      when: formal_spike_documentation_needed
      note: "Use for time-boxed review investigation with clear success criteria"

  step_3_codebase_inventory:
    action: Catalog and understand the code to be reviewed
    inventory_areas:
      - file_structure
      - module_organization
      - dependencies_map
      - code_volume_metrics
      - technology_stack
      - architectural_patterns
    tools:
      - file_exploration
      - dependency_analysis
      - git_history_review
      - code_metrics
    deep_analysis:
      focus: codebase_understanding
      approach: systematic_inventory
      outputs:
        - file_catalog
        - dependency_graph
        - architecture_overview
        - code_metrics_baseline
        - technology_assessment
        - organizational_patterns
        - entry_points_identified
    validation: codebase_cataloged

  step_4_parallel_code_review:
    description: "Parallel Code Review: Standards, Quality, Security, Performance, Architecture, Accessibility, Debt"
    parallel_execution:
      mode: concurrent
      sub_agents:
        - standards_auditor
        - quality_analyst
        - security_expert
        - performance_engineer
        - architecture_reviewer
        - accessibility_specialist
        - debt_assessor
      coordination:
        - All 7 agents work independently
        - Each produces focused analysis
        - Shared access to codebase inventory
      outputs_per_agent:
        standards_auditor:
          - compliance_report
          - deviations_identified
          - missing_documentation
          - pattern_violations
          - best_practice_gaps
          - standards_recommendations
        quality_analyst:
          - quality_metrics
          - maintainability_score
          - complexity_hotspots
          - duplication_report
          - refactoring_opportunities
          - technical_debt_assessment
        security_expert:
          - vulnerability_catalog
          - risk_severity_ratings
          - attack_vector_analysis
          - security_recommendations
          - compliance_gaps
          - remediation_priorities
        performance_engineer:
          - performance_issues_catalog
          - bottleneck_locations
          - optimization_opportunities
          - performance_metrics
          - improvement_recommendations
        architecture_reviewer:
          - architecture_diagram
          - design_pattern_analysis
          - structural_issues
          - scalability_assessment
          - architectural_recommendations
          - refactoring_strategies
        accessibility_specialist:
          - accessibility_violations
          - wcag_compliance_level
          - user_impact_assessment
          - remediation_guide
          - best_practice_recommendations
        debt_assessor:
          - debt_catalog
          - impact_assessment
          - cost_estimation
          - priority_ranking
          - remediation_roadmap
          - quick_win_opportunities
    chrome_devtools:
      when: environment_provided
      distributed_to: all_review_agents
      actions:
        - inspect_network_requests
        - analyze_cookies_storage
        - check_security_headers
        - performance_profiling
        - memory_analysis
        - accessibility_audit
        - lighthouse_audit
    validation: parallel_review_complete

  step_5_external_research:
    action: Research best practices and industry standards
    sources:
      - official_documentation
      - security_advisories
      - performance_guides
      - accessibility_standards
      - industry_best_practices
      - framework_recommendations
    deep_analysis:
      focus: external_best_practices_research
      approach: comprehensive_research
      outputs:
        - best_practices_summary
        - industry_standards_comparison
        - tool_recommendations
        - pattern_libraries
        - security_guidelines
        - performance_benchmarks
    validation: external_research_complete

  step_6_review_and_prioritization:
    description: "Review: Validate Completeness & Prioritize Findings"
    sub_agent: reviewer
    inputs:
      - standards_auditor_output
      - quality_analyst_output
      - security_expert_output
      - performance_engineer_output
      - architecture_reviewer_output
      - accessibility_specialist_output
      - debt_assessor_output
      - external_research_output
    actions:
      - validate_analysis_completeness
      - resolve_contradictions
      - assess_severity_ratings
      - prioritize_findings
      - categorize_recommendations
      - estimate_implementation_effort
      - calculate_impact_benefit_ratios
      - identify_quick_wins
    severity_validation:
      critical:
        - security_vulnerabilities
        - data_loss_risks
        - production_blockers
      high:
        - performance_issues
        - accessibility_violations
        - architectural_problems
      medium:
        - code_quality_issues
        - technical_debt
        - missing_documentation
      low:
        - minor_improvements
        - style_inconsistencies
        - optimization_opportunities
    outputs:
      - validation_report
      - prioritized_findings
      - severity_assessments
      - implementation_roadmap
      - completeness_confirmation
    validation: findings_prioritized

  step_7_synthesis_research_document:
    description: "Synthesis: Generate Comprehensive research.md"
    sub_agent: synthesizer
    inputs:
      - validation_report
      - all_agent_outputs
      - prioritization_results
    actions:
      - generate_research_md
      - integrate_all_findings
      - format_per_review_template
      - create_improvement_roadmap
      - document_implementation_guidance
    outputs:
      - research.md: comprehensive_review_documentation
    command: /speckit.checklist
    decision_records:
      command: /speckit.decision [decision-context]
      when: significant_improvement_decision_needs_documentation
      note: "Document improvement decisions with trade-offs and alternatives"
    required_sections:
      executive_summary:
        - review_overview
        - key_findings
        - critical_issues
        - overall_assessment
        - recommendation_summary
      review_methodology:
        - scope_definition
        - review_process
        - tools_used
        - standards_applied
        - limitations
      standards_compliance:
        - code_standards_assessment
        - pattern_compliance
        - deviation_analysis
        - compliance_score
        - recommendations
      code_quality:
        - maintainability_metrics
        - complexity_analysis
        - duplication_report
        - refactoring_opportunities
        - quality_score
      security_findings:
        - vulnerability_catalog
        - risk_assessment
        - security_score
        - remediation_priorities
        - security_best_practices
      performance_findings:
        - performance_issues
        - bottleneck_analysis
        - optimization_opportunities
        - performance_score
        - implementation_guide
      architecture_findings:
        - architectural_assessment
        - design_pattern_analysis
        - structural_issues
        - scalability_evaluation
        - architectural_recommendations
      accessibility_findings:
        - accessibility_violations
        - wcag_compliance
        - user_impact
        - remediation_guide
        - accessibility_score
      technical_debt:
        - debt_inventory
        - impact_assessment
        - cost_estimation
        - remediation_roadmap
        - quick_wins
      improvement_recommendations:
        - critical_actions
        - high_priority_improvements
        - medium_priority_improvements
        - low_priority_improvements
        - implementation_effort
        - expected_impact
      implementation_guide:
        - step_by_step_instructions
        - code_examples
        - migration_patterns
        - testing_approach
        - rollout_strategy
      code_examples:
        - before_after_comparisons
        - best_practice_examples
        - pattern_implementations
        - refactoring_examples
      testing_recommendations:
        - test_coverage_gaps
        - test_strategy
        - test_examples
        - edge_cases
      monitoring_recommendations:
        - metrics_to_track
        - alerting_setup
        - logging_improvements
        - diagnostic_tools
    main_agent_finalization:
      by: MAIN_AGENT
      action: QA review and finalization of research.md
      checks:
        - confirm_alignment_with_request_and_context
        - validate_completeness_and_consistency
        - ensure_output_format_and_sections_present
        - verify_severity_ratings_appropriate
        - resolve_remaining_open_questions_or_note_them
      outputs:
        - main_agent_review_notes
        - final_signoff: true
    validation: documentation_complete
    final_output:
      location: "[SPEC_FOLDER]/research.md"
      summary_message: |
        Code review research complete.
        Comprehensive code review has been documented in [SPEC_FOLDER]/research.md
        This document serves as the authoritative reference for improvement implementation.

        Spec folder structure:
        - [SPEC_FOLDER]/research.md - Complete code review documentation
        - [SPEC_FOLDER]/checklist.md - Quality verification checklist

        Next steps:
        - Review findings and recommendations in the spec folder
        - Prioritize improvements based on impact and effort
        - Create implementation plan for critical/high-priority items
        - Use research as reference during improvement work

  step_8_save_context:
    action: Save code review conversation context via parallel sub-agent
    description: |
      Preserve comprehensive code review conversation including:
      - Review methodology and findings
      - Analysis across all quality dimensions
      - Improvement recommendations and prioritization
      - Implementation guidance and examples
    sub_agent: context_saver
    outputs:
      - context_file: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__review_session.md"
      - workflow_flowchart: auto_generated
      - review_decisions: documented
    validation: context_saved_successfully
    note: |
      Context saved alongside research.md for complete documentation.
      Captures full review journey and decision-making process.

termination:
  after_step: 8
  message: "Code review research completed successfully. Workflow terminated after step 8 (save context)."

# ─────────────────────────────────────────────────────────────────
# REVIEW STANDARDS
# ─────────────────────────────────────────────────────────────────
review_standards:
  code_quality:
    - follows .claude/knowledge/code_standards.md
    - follows .claude/knowledge/initialization_pattern.md
    - follows .claude/knowledge/animation_strategy.md
    - readable_and_maintainable
    - well_documented
    - properly_tested

  security:
    - owasp_top_10_compliance
    - input_validation
    - authentication_authorization
    - data_protection
    - secure_dependencies

  performance:
    - efficient_algorithms
    - optimized_rendering
    - 60_fps_animations
    - minimal_memory_usage
    - optimized_network_usage

  accessibility:
    - wcag_2.1_aa_compliance
    - semantic_html
    - keyboard_navigation
    - screen_reader_support
    - color_contrast

  architecture:
    - solid_principles
    - design_patterns
    - separation_of_concerns
    - scalability
    - maintainability

# ─────────────────────────────────────────────────────────────────
# QUALITY STANDARDS
# ─────────────────────────────────────────────────────────────────
quality_standards:
  documentation:
    - production_ready_examples
    - defensive_programming_patterns
    - error_handling_strategies
    - security_best_practices
    - performance_optimization_guidance
  code_examples:
    - working_snippets
    - before_after_comparisons
    - best_practice_demonstrations
    - anti_pattern_identification
    - refactoring_guidance
  analysis_depth:
    - edge_cases_covered
    - security_threats_identified
    - performance_implications_assessed
    - accessibility_impact_evaluated
    - maintainability_considered

# ─────────────────────────────────────────────────────────────────
# SEVERITY RATINGS
# ─────────────────────────────────────────────────────────────────
severity_ratings:
  critical:
    definition: "Security vulnerabilities, data loss risks, production blockers"
    response_time: immediate
    examples:
      - sql_injection_vulnerability
      - authentication_bypass
      - data_corruption_risk
      - memory_leaks
      - crash_causing_bugs

  high:
    definition: "Performance issues, accessibility violations, architectural problems"
    response_time: urgent
    examples:
      - poor_performance_affecting_ux
      - wcag_violations
      - significant_technical_debt
      - scalability_concerns
      - security_misconfigurations

  medium:
    definition: "Code quality issues, maintainability concerns, missing documentation"
    response_time: scheduled
    examples:
      - high_complexity_code
      - code_duplication
      - missing_tests
      - inconsistent_patterns
      - documentation_gaps

  low:
    definition: "Minor improvements, style inconsistencies, optimization opportunities"
    response_time: backlog
    examples:
      - naming_improvements
      - code_style_violations
      - minor_optimizations
      - comment_improvements
      - dead_code_removal

# ─────────────────────────────────────────────────────────────────
# RESEARCH DOCUMENTS
# ─────────────────────────────────────────────────────────────────
documents:
  primary_deliverable:
    type: research_document
    format: markdown
    location: "[SPEC_FOLDER]/research.md"
    versioning: semantic
    review_required: true
  supplementary_materials:
    location: "[SPEC_FOLDER]/"
    optional_files:
      - security_audit.md
      - performance_audit.md
      - accessibility_audit.md
      - refactoring_guide.md
      - test_strategy.md
      - migration_plan.md

# ─────────────────────────────────────────────────────────────────
# SPEC FOLDER INTEGRATION
# ─────────────────────────────────────────────────────────────────
spec_folder_structure:
  note: |
    This workflow generates research.md within a spec folder structure.
    It does NOT follow the full GitHub SpecKit workflow (no /specify, /plan, etc).
    It creates comprehensive code review documentation to support improvement planning.

  workflow_relationship:
    - This is a standalone code review research workflow with parallel analysis
    - Outputs to spec folders for consistency
    - Can be used before or during SpecKit workflows
    - Provides review foundation for improvement specifications

  expected_output:
    - "[SPEC_FOLDER]/research.md - Primary code review documentation"
    - "[SPEC_FOLDER]/checklist.md - Quality verification checklist"
    - "Optional supplementary files in spec folder as needed"

# ─────────────────────────────────────────────────────────────────
# SUCCESS CRITERIA
# ─────────────────────────────────────────────────────────────────
success:
  completeness:
    - all_review_areas_covered
    - findings_documented
    - recommendations_provided
    - implementation_guidance_included

  actionability:
    - clear_prioritization
    - effort_estimates_provided
    - implementation_examples_included
    - success_criteria_defined

  quality:
    - comprehensive_analysis
    - evidence_based_findings
    - practical_recommendations
    - maintainable_documentation

# ─────────────────────────────────────────────────────────────────
# ADAPTIVE RULES & ERROR HANDLING
# ─────────────────────────────────────────────────────────────────
adaptive_rules:
  high_complexity:
    concurrency: 2
    review_depth: exhaustive
  high_uncertainty:
    insert: discovery_microstep_before_parallel_blocks
    estimates: use_ranges
  parallel_not_supported:
    concurrency: 1
    note: "If parallel sub-agents unsupported, run tasks one-by-one; keep review and synthesis."

error_handling:
  retry_policy:
    targeted: true
    max_retries: 2
  fallback:
    on_repeated_failure: rerun_failed_tasks_sequentially
    proceed_with_partial: true

# ─────────────────────────────────────────────────────────────────
# OUTPUT FORMAT
# ─────────────────────────────────────────────────────────────────
output:
  review_report: |
    ## Code Review Research Report

    ### Executive Summary
    - Overall Quality Score: X/10
    - Critical Issues: N
    - High Priority Issues: N
    - Medium Priority Issues: N
    - Low Priority Issues: N

    ### Key Findings
    1. [Finding 1]
       - Category: Security/Performance/Quality/etc.
       - Severity: Critical/High/Medium/Low
       - Impact: [Description]
       - Recommendation: [Action]

    2. [Finding 2]
       - Category: Security/Performance/Quality/etc.
       - Severity: Critical/High/Medium/Low
       - Impact: [Description]
       - Recommendation: [Action]

    ### Quality Scores
    - Standards Compliance: X/10
    - Code Quality: X/10
    - Security: X/10
    - Performance: X/10
    - Architecture: X/10
    - Accessibility: X/10

    ### Priority Recommendations
    #### Critical (Immediate Action Required)
    1. [Action 1] - Effort: Low/Medium/High - Impact: High

    #### High Priority (Urgent)
    1. [Action 1] - Effort: Low/Medium/High - Impact: High

    #### Medium Priority (Scheduled)
    1. [Action 1] - Effort: Low/Medium/High - Impact: Medium

    #### Low Priority (Backlog)
    1. [Action 1] - Effort: Low/Medium/High - Impact: Low

    ### Implementation Roadmap
    - Phase 1 (Critical): [Actions]
    - Phase 2 (High Priority): [Actions]
    - Phase 3 (Medium Priority): [Actions]
    - Phase 4 (Low Priority): [Actions]

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
    - follow_review_methodology
    - document_all_findings
    - provide_evidence
    - prioritize_by_severity_and_impact
    - include_actionable_recommendations
    - provide_code_examples
    - verify_against_standards
    - assess_security_implications
    - evaluate_performance_impact
    - check_accessibility_compliance
    - generate_comprehensive_documentation
    - self_validate_and_proceed
    - do_not_prompt_for_user_approval
    - limit_context_to_active_scope
    - enforce_review_before_synthesis
    - apply_minimum_needed_change

  NEVER:
    - skip_review_areas
    - provide_vague_recommendations
    - ignore_security_concerns
    - overlook_accessibility_issues
    - dismiss_technical_debt
    - proceed_to_implementation
    - invent_new_patterns_when_existing_work
    - make_unsubstantiated_claims
    - skip_workflow_steps
    - ignore_blockers

  PRIORITIZE:
    - security_vulnerabilities_first
    - user_impact_over_code_elegance
    - actionable_over_theoretical
    - practical_over_perfect
    - clear_over_clever