#!/bin/bash

# ───────────────────────────────────────────────────────────────
# AUTO SAVE-CONTEXT ON SESSION END
# ───────────────────────────────────────────────────────────────
# SessionEnd hook that automatically saves conversation context
# when a session terminates (clear, logout, exit)
#
# Version: 1.0.0
# Last Updated: 2025-11-08
# ───────────────────────────────────────────────────────────────

# Source output helpers (completely silent on success)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" 2>/dev/null && pwd)"
source "$SCRIPT_DIR/../lib/output-helpers.sh" || exit 0

# Check dependencies (silent on success)
check_dependency "jq" "brew install jq (macOS) or apt install jq (Linux)" || exit 0
check_dependency "node" "Install from https://nodejs.org/" || exit 0

# Read JSON input from stdin
INPUT=$(cat)

# Extract hook data (silent on error)
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // empty' 2>/dev/null)
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path // empty' 2>/dev/null)
REASON=$(echo "$INPUT" | jq -r '.reason // empty' 2>/dev/null)
CWD=$(echo "$INPUT" | jq -r '.cwd // empty' 2>/dev/null)

# Debug logging (uncomment for troubleshooting)
# echo "DEBUG: SessionEnd triggered" >&2
# echo "  Session ID: $SESSION_ID" >&2
# echo "  Reason: $REASON" >&2
# echo "  Transcript: $TRANSCRIPT_PATH" >&2

# ───────────────────────────────────────────────────────────────
# VALIDATION CHECKS
# ───────────────────────────────────────────────────────────────

# Only save on specific exit reasons
case "$REASON" in
  "clear"|"logout"|"prompt_input_exit")
    # Proceed with save
    ;;
  *)
    # Unknown or unhandled reason, skip silently
    exit 0
    ;;
esac

# Expand tilde in transcript path
TRANSCRIPT_PATH="${TRANSCRIPT_PATH/#\~/$HOME}"

# Check if transcript exists and is readable
if [ ! -f "$TRANSCRIPT_PATH" ] || [ ! -r "$TRANSCRIPT_PATH" ]; then
  echo "⚠️  Transcript not found or not readable: $TRANSCRIPT_PATH" >&2
  exit 0
fi

# Check if we're in a valid project directory
if [ -z "$CWD" ] || [ ! -d "$CWD" ]; then
  echo "⚠️  Invalid working directory: $CWD" >&2
  exit 0
fi

# Check if project has specs/ folder
if [ ! -d "$CWD/specs" ]; then
  # No specs folder - skip save silently (user may not be using spec system)
  exit 0
fi

# ───────────────────────────────────────────────────────────────
# FIND TARGET SPEC FOLDER
# ───────────────────────────────────────────────────────────────

# Find most recent spec folder (format: ###-name)
SPEC_FOLDER=$(find "$CWD/specs" -maxdepth 1 -type d -name "[0-9][0-9][0-9]-*" 2>/dev/null | sort -r | head -1)

if [ -z "$SPEC_FOLDER" ]; then
  # No numbered spec folder found - skip save
  echo "⚠️  No spec folder (###-name) found in $CWD/specs/" >&2
  echo "    Create a spec folder first: mkdir -p specs/###-topic-name" >&2
  exit 0
fi

SPEC_FOLDER_NAME=$(basename "$SPEC_FOLDER")

# Create memory directory if it doesn't exist
CONTEXT_DIR="$SPEC_FOLDER/memory"
mkdir -p "$CONTEXT_DIR"

# ───────────────────────────────────────────────────────────────
# TRANSFORM TRANSCRIPT TO SAVE-CONTEXT FORMAT
# ───────────────────────────────────────────────────────────────

# Create temporary file for transformed data
TEMP_JSON="/tmp/save-context-data-${SESSION_ID}.json"

# Get path to transformer script
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TRANSFORMER="$HOOK_DIR/../lib/transform-transcript.js"

if [ ! -f "$TRANSFORMER" ]; then
  echo "❌ Transformer script not found: $TRANSFORMER" >&2
  exit 1
fi

# Run transformation
print_message "PROCESS" "Transforming transcript data..."

node "$TRANSFORMER" "$TRANSCRIPT_PATH" "$TEMP_JSON" 2>&1

# Check if transformation succeeded
if [ ! -f "$TEMP_JSON" ]; then
  echo "❌ Transcript transformation failed" >&2
  exit 1
fi

# ───────────────────────────────────────────────────────────────
# EXECUTE SAVE-CONTEXT SCRIPT
# ───────────────────────────────────────────────────────────────

# Change to project directory
cd "$CWD" || {
  echo "❌ Failed to change to project directory: $CWD" >&2
  rm -f "$TEMP_JSON"
  exit 1
}

# Check if save-context skill exists
SAVE_CONTEXT_SCRIPT="$CWD/.claude/skills/save-context/scripts/generate-context.js"

if [ ! -f "$SAVE_CONTEXT_SCRIPT" ]; then
  echo "❌ save-context skill not found at: $SAVE_CONTEXT_SCRIPT" >&2
  rm -f "$TEMP_JSON"
  exit 1
fi

# Execute save-context script
print_message "SAVE" "Auto-saving context to: $SPEC_FOLDER_NAME/memory/"
print_line

# Run in auto-save mode (bypasses alignment prompts)
# Spec folders: saves to memory/ subfolder
# Memory fallback: saves directly to Memory/ folder
AUTO_SAVE_MODE=true node "$SAVE_CONTEXT_SCRIPT" "$TEMP_JSON" 2>&1

EXIT_CODE=$?

# Clean up temporary file
rm -f "$TEMP_JSON"

# Report result
print_line
if [ $EXIT_CODE -eq 0 ]; then
  print_separator
  print_message "SUCCESS" "Context saved successfully!"
  if [ "$SPEC_FOLDER_NAME" = "Memory" ]; then
    print_detail "Location: Memory/"
  else
    print_detail "Location: $SPEC_FOLDER_NAME/memory/"
  fi
  print_detail "Trigger: Session ended ($REASON)"
  print_separator
else
  print_message "WARN" "save-context script exited with code $EXIT_CODE"
fi

# Always exit with success to not block session end
exit 0
